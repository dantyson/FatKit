!function(t){var e;window.FatKit&&(e=t(FatKit)),"function"==typeof define&&define.amd&&define("fatkit-nestable",["fatkit"],function(){return e||t(FatKit)})}(function(t){"use strict";var e,s="ontouchstart"in window,i=t.$html,a=[],n=t.$win,l=function(){var t=document.createElement("div"),e=document.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",e.appendChild(t);var s=window.getComputedStyle&&"auto"===window.getComputedStyle(t,"").pointerEvents;return e.removeChild(t),!!s}(),o=s?"touchstart":"mousedown",h=s?"touchmove":"mousemove",r=s?"touchend":"mouseup",d=s?"touchcancel":"mouseup";return t.component("nestable",{defaults:{prefix:"f-",listNodeName:"ul",itemNodeName:"li",listBaseClass:"{prefix}nestable",listClass:"{prefix}nestable-list",listitemClass:"{prefix}nestable-list-item",itemClass:"{prefix}nestable-item",dragClass:"{prefix}nestable-list-dragged",movingClass:"{prefix}nestable-moving",handleClass:"{prefix}nestable-handle",collapsedClass:"{prefix}collapsed",placeClass:"{prefix}nestable-placeholder",noDragClass:"{prefix}nestable-nodrag",emptyClass:"{prefix}nestable-empty",group:0,maxDepth:10,threshold:20},boot:function(){t.$html.on("mousemove touchmove",function(){if(e){var s=e.offset().top;s<t.$win.scrollTop()?t.$win.scrollTop(t.$win.scrollTop()-Math.ceil(e.height()/2)):s+e.height()>window.innerHeight+t.$win.scrollTop()&&t.$win.scrollTop(t.$win.scrollTop()+Math.ceil(e.height()/2))}}),t.ready(function(e){t.$("[data-f-nestable]",e).each(function(){var e=t.$(this);if(!e.data("nestable")){t.nestable(e,t.Utils.options(e.attr("data-f-nestable")))}})})},init:function(){var i=this;Object.keys(this.options).forEach(function(t){-1!=String(i.options[t]).indexOf("{prefix}")&&(i.options[t]=i.options[t].replace("{prefix}",i.options.prefix))}),this.tplempty='<div class="'+this.options.emptyClass+'"/>',this.find(">"+this.options.itemNodeName).addClass(this.options.listitemClass).end().find("ul:not(.ignore-list)").addClass(this.options.listClass).find(">li").addClass(this.options.listitemClass),this.element.children(this.options.itemNodeName).length||this.element.append(this.tplempty),this.element.data("nestable-id","ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random())),this.reset(),this.element.data("nestable-group",this.options.group),this.placeEl=t.$('<div class="'+this.options.placeClass+'"/>'),this.find(this.options.itemNodeName).each(function(){i.setParent(t.$(this))}),this.on("click","[data-nestable-action]",function(e){if(!i.dragEl&&(s||0===e.button)){e.preventDefault();var a=t.$(e.currentTarget),n=a.data("nestableAction"),l=a.closest(i.options.itemNodeName);"collapse"===n&&i.collapseItem(l),"expand"===n&&i.expandItem(l),"toggle"===n&&i.toggleItem(l)}});var a=function(e){var a=t.$(e.target);if(!a.hasClass(i.options.handleClass)){if(a.closest("."+i.options.noDragClass).length)return;a=a.closest("."+i.options.handleClass)}!a.length||i.dragEl||!s&&0!==e.button||s&&1!==e.touches.length||(e.preventDefault(),i.dragStart(s?e.touches[0]:e),i.trigger("start.f.nestable",[i]))},l=function(t){i.dragEl&&(t.preventDefault(),i.dragMove(s?t.touches[0]:t),i.trigger("move.f.nestable",[i]))},p=function(t){i.dragEl&&(t.preventDefault(),i.dragStop(s?t.touches[0]:t)),e=!1};s?(this.element[0].addEventListener(o,a,!1),window.addEventListener(h,l,!1),window.addEventListener(r,p,!1),window.addEventListener(d,p,!1)):(this.on(o,a),n.on(h,l),n.on(r,p))},serialize:function(){var e,s=0,i=this,a=function(e,s){var n=[],l=e.children(i.options.itemNodeName);return l.each(function(){for(var e,l=t.$(this),o={},h=l.children(i.options.listNodeName),r=0;r<l[0].attributes.length;r++)e=l[0].attributes[r],0===e.name.indexOf("data-")&&(o[e.name.substr(5)]=t.Utils.str2json(e.value));h.length&&(o.children=a(h,s+1)),n.push(o)}),n};return e=a(i.element,s)},list:function(e){var s=[],i=this,a=0,n=function(i,a,l){var o=i.children(e.itemNodeName);o.each(function(i){var o=t.$(this),h=t.$.extend({parent_id:l?l:null,depth:a,order:i},o.data()),r=o.children(e.listNodeName);s.push(h),r.length&&n(r,a+1,o.data(e.idProperty||"id"))})};return e=t.$.extend({},i.options,e),n(i.element,a),s},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null;for(var t=0;t<a.length;t++)this.checkEmptyList(a[t]);a=[]},toggleItem:function(t){this[t.hasClass(this.options.collapsedClass)?"expandItem":"collapseItem"](t)},expandItem:function(t){t.removeClass(this.options.collapsedClass)},collapseItem:function(t){var e=t.children(this.options.listNodeName);e.length&&t.addClass(this.options.collapsedClass)},expandAll:function(){var e=this;this.find(e.options.itemNodeName).each(function(){e.expandItem(t.$(this))})},collapseAll:function(){var e=this;this.find(e.options.itemNodeName).each(function(){e.collapseItem(t.$(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&t.addClass("f-parent")},unsetParent:function(t){t.removeClass("f-parent "+this.options.collapsedClass),t.children(this.options.listNodeName).remove()},dragStart:function(s){var a=this.mouse,n=t.$(s.target),l=n.closest(this.options.itemNodeName),o=l.offset();this.placeEl.css("height",l.height()),a.offsetX=s.pageX-o.left,a.offsetY=s.pageY-o.top,a.startX=a.lastX=o.left,a.startY=a.lastY=o.top,this.dragRootEl=this.element,this.dragEl=t.$(document.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",l.width()),e=this.dragEl,this.tmpDragOnSiblings=[l[0].previousSibling,l[0].nextSibling],l.after(this.placeEl),l[0].parentNode.removeChild(l[0]),l.appendTo(this.dragEl),t.$body.append(this.dragEl),this.dragEl.css({left:o.left,top:o.top});var h,r,d=this.dragEl.find(this.options.itemNodeName);for(h=0;h<d.length;h++)r=t.$(d[h]).parents(this.options.listNodeName).length,r>this.dragDepth&&(this.dragDepth=r);i.addClass(this.options.movingClass)},dragStop:function(){var t=this.dragEl.children(this.options.itemNodeName).first(),e=this.placeEl.parents("."+this.options.listBaseClass+":first");t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.element[0]!==e[0]?(e.trigger("change.f.nestable",[t,"added",e,e.data("nestable")]),this.element.trigger("change.f.nestable",[t,"removed",this.element,this])):this.element.trigger("change.f.nestable",[t,"moved",this.element,this]),this.trigger("stop.f.nestable",[this,t]),this.reset(),i.removeClass(this.options.movingClass)},dragMove:function(e){var s,i,n,o,h,r=this.options,d=this.mouse;this.dragEl.css({left:e.pageX-d.offsetX,top:e.pageY-d.offsetY}),d.lastX=d.nowX,d.lastY=d.nowY,d.nowX=e.pageX,d.nowY=e.pageY,d.distX=d.nowX-d.lastX,d.distY=d.nowY-d.lastY,d.lastDirX=d.dirX,d.lastDirY=d.dirY,d.dirX=0===d.distX?0:d.distX>0?1:-1,d.dirY=0===d.distY?0:d.distY>0?1:-1;var p=Math.abs(d.distX)>Math.abs(d.distY)?1:0;if(!d.moving)return d.dirAx=p,d.moving=!0,void 0;d.dirAx!==p?(d.distAxX=0,d.distAxY=0):(d.distAxX+=Math.abs(d.distX),0!==d.dirX&&d.dirX!==d.lastDirX&&(d.distAxX=0),d.distAxY+=Math.abs(d.distY),0!==d.dirY&&d.dirY!==d.lastDirY&&(d.distAxY=0)),d.dirAx=p,d.dirAx&&d.distAxX>=r.threshold&&(d.distAxX=0,n=this.placeEl.prev(r.itemNodeName),d.distX>0&&n.length&&!n.hasClass(r.collapsedClass)&&(s=n.find(r.listNodeName).last(),h=this.placeEl.parents(r.listNodeName).length,h+this.dragDepth<=r.maxDepth&&(s.length?(s=n.children(r.listNodeName).last(),s.append(this.placeEl)):(s=t.$("<"+r.listNodeName+"/>").addClass(r.listClass),s.append(this.placeEl),n.append(s),this.setParent(n)))),d.distX<0&&(o=this.placeEl.next(r.itemNodeName),o.length||(i=this.placeEl.parent(),this.placeEl.closest(r.itemNodeName).after(this.placeEl),i.children().length||this.unsetParent(i.parent()))));var c=!1;if(l||(this.dragEl[0].style.visibility="hidden"),this.pointEl=t.$(document.elementFromPoint(e.pageX-document.body.scrollLeft,e.pageY-(window.pageYOffset||document.documentElement.scrollTop))),l||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(r.handleClass))this.pointEl=this.pointEl.closest(r.itemNodeName);else{var m=this.pointEl.closest("."+r.itemClass);m.length&&(this.pointEl=m.closest(r.itemNodeName))}if(this.pointEl.hasClass(r.emptyClass))c=!0;else if(this.pointEl.data("nestable")&&!this.pointEl.children().length)c=!0,this.pointEl=t.$(this.tplempty).appendTo(this.pointEl);else if(!this.pointEl.length||!this.pointEl.hasClass(r.listitemClass))return;var f=this.element,g=this.pointEl.closest("."+this.options.listBaseClass),u=f[0]!==this.pointEl.closest("."+this.options.listBaseClass)[0];if(!d.dirAx||u||c){if(u&&r.group!==g.data("nestable-group"))return;if(a.push(f),h=this.dragDepth-1+this.pointEl.parents(r.listNodeName).length,h>r.maxDepth)return;var E=e.pageY<this.pointEl.offset().top+this.pointEl.height()/2;i=this.placeEl.parent(),c?this.pointEl.replaceWith(this.placeEl):E?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),i.children().length||i.data("nestable")||this.unsetParent(i.parent()),this.checkEmptyList(this.dragRootEl),this.checkEmptyList(f),u&&(this.dragRootEl=g,this.hasNewRoot=this.element[0]!==this.dragRootEl[0])}},checkEmptyList:function(e){e=e?t.$(e):this.element,e.children().length||e.find("."+this.options.emptyClass).remove().end().append(this.tplempty)}}),t.nestable});